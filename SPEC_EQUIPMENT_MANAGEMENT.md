# 装備整理・一括売却・自動売却機能 詳細仕様書

## 1. 概要
放置進行やダンジョン周回によってドロップする大量の装備品を、効率的に整理・売却し、システム（Mumel）サイクルへ還元するための機能を実装する。
本仕様では、「お気に入り（ロック）」「一括売却」「自動売却」の3つの主軸機能について定義する。

## 2. 機能仕様

### 2-1. お気に入り（ロック）機能
プレイヤーが誤って重要な装備を売却・破棄することを防ぐための保護機能。

*   **データ構造**:
    *   `player.inventory` 内の各アイテムオブジェクトに `isLocked: boolean` プロパティを追加。
    *   デフォルトは `false` (未指定も `false` 扱い)。
*   **UI/UX**:
    *   **装備画面（インベントリ一覧）**: 各アイテムの表示部分（右下など）に「鍵マーク」アイコンまたはボタンを設置する。
    *   **操作**: 鍵アイコンをクリック（タップ）することで、`isLocked` の `true`/`false` をトグル切り替えする。
    *   **視覚的フィードバック**:
        *   ロック中: アイコンが閉じた鍵（🔒）になり、強調表示される。
        *   未ロック: アイコンが開いた鍵（🔓）またはうっすらと表示される。
*   **制約**:
    *   `isLocked === true` の装備は、単体売却ボタンが非活性化（無効化）されるか、押下時に「ロックされているため売却できません」と警告を出す。
    *   後述の一括売却の対象から必ず除外される。

### 2-2. 一括売却機能
インベントリに溜まった不要な装備を一回の操作でまとめて売却する機能。

*   **UI/UX**:
    *   **ボタン設置**: 装備画面（`screen-equipment`）の上部または下部に「一括売却」ボタンを新設。
    *   **確認モーダル**: ボタン押下時、一括売却の条件設定ダイアログを表示する。
*   **フィルタ設定（条件）**:
    ダイアログ内で以下のフィルタを選択可能にする（ラジオボタン等）。
    1. コモン（白）のみ売却
    2. アンコモン（緑）以下を売却
    3. レア（青）以下を売却
    *※エピック以上の高レアリティを一括売却するオプションは、事故防止のため含めないか、厳重な警告を設ける。*
*   **売却ロジック**:
    *   **対象抽出**: インベントリ内のアイテムのうち、以下の条件を**すべて満たす**ものを対象とする。
        1. 装備中ではない（現在の装備ステータスにセットされていない）
        2. ロックされていない（`!item.isLocked`）
        3. レアリティがフィルタの条件以下である
    *   **処理**: 抽出したアイテムの合計売却価格を計算して `player.money` に加算し、インベントリ配列から安全に一括削除する。
*   **結果表示**:
    *   売却完了後、アラートテキストまたはゲーム内ログに「N個の装備を売却し、M Mumelを獲得しました」と表示する。

### 2-3. 自動売却（オートセル）機能
放置プレイの効率を最大化するため、ドロップ判定の時点で不要なアイテムを拾わずに直接資金へ変換する機能。

*   **UI/UX**:
    *   **設定場所**: メニューの「ステータス」付近、または装備画面内の「自動売却設定」領域。
    *   **設定項目**: 「自動売却を有効にする対象レアリティ」をドロップダウン等で選択。
        *   OFF（自動売却しない）
        *   コモン以下を自動売却
        *   アンコモン以下を自動売却
*   **データ構造**:
    *   セーブデータの `player` オブジェクト内に `autoSellRarity: integer` (-1: OFF, 0: Common, 1: Uncommon, ...) を追加。
*   **判定ロジック (`game.js` -> `checkEnemyDrops` 内へのフック)**:
    *   敵を倒してドロップ抽選に当選した際、生成されたアイテムのレアリティ（`rarity`）を評価する。
    *   `rarity <= player.autoSellRarity` である場合：
        1. インベントリ（`player.inventory`）には追加**しない**。
        2. 直ちに該当アイテムの売却価格分を `player.money` に加算する。
        3. コンバットログに専用の表示を行う（例：「[自動売却] {アイテム名} (+{価格} Mumel)」）。

## 3. 実装のフェーズ分け・ロードマップ
実装漏れやバグを防ぐため、以下の順序でインクリメンタル（段階的）に実装を行う。

*   **Phase 1: 「お気に入り（ロック）」の基盤実装**
    *   ロックボタンのDOM構築、クリックイベント、セーブデータへの保存・復元、単体売却時のバリデーション実装。
*   **Phase 2: 「一括売却」の実装**
    *   UI（一括売却ボタンとモーダル）の作成、対象アイテムの抽出ロジック、一括削除と清算処理の実装。
*   **Phase 3: 「自動売却」の実装**
    *   設定UIの追加、ドロップ判定ロジックへの介入（フック処理）、専用コンバットログの追加。

## 4. 影響範囲・技術的な特記事項
*   既存の `renderEquipmentScreen()` 関数のDOM生成ロジックに手を入れるため、インベントリの再描画パフォーマンスに注意する。
*   配列の一括削除時、既存の売却ロジック（`sellItem(index)`）のようにインデックス（添え字）のズレによるバグを引き起こさないよう、`filter` を用いて新しいインベントリ配列を生成する安全なマッピング方式を採用する。
*   データ構造（`isLocked`, `autoSellRarity`）が追加されるため、既存のセーブデータ読み込み時に初期値（フォールバック）が正しく設定されるよう配慮する。
